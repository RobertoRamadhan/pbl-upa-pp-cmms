generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

model SystemUser {
  id                String             @id
  username          String             @unique
  password          String
  role              user_role          @default(STAFF)
  name              String
  email             String             @unique
  phone             String?
  department        String?
  joinDate          DateTime           @default(now())
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  assignedTasks     Assignment[]       @relation("AssignedBy")
  assignedToMe      Assignment[]       @relation("AssignedTo")
  repairLogs        RepairLog[]
  technicianProfile TechnicianProfile?
  tickets           Ticket[]
  notifications     Notification[]
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      SystemUser       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MaintenanceHistory {
  id          String          @id @default(uuid())
  assetId     String
  ticketId    String
  type        MaintenanceType
  description String
  cost        Float?
  performedAt DateTime
  createdAt   DateTime        @default(now())
  asset       Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  ticket      Ticket          @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([ticketId])
}

model Assignment {
  id           String            @id @default(uuid())
  ticketId     String            @unique
  technicianId String
  assignedById String
  status       assignment_status @default(PENDING)
  notes        String?
  startTime    DateTime?
  endTime      DateTime?
  assignedAt   DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  assignedBy   SystemUser        @relation("AssignedBy", fields: [assignedById], references: [id], onDelete: Cascade)
  technician   SystemUser        @relation("AssignedTo", fields: [technicianId], references: [id], onDelete: Cascade)
  ticket       Ticket            @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  materials    Material[]
  repairLogs   RepairLog[]

  @@index([assignedById])
  @@index([technicianId])
}

model Asset {
  id                 String               @id @default(uuid())
  code               String               @unique
  name               String
  category           String
  location           String
  status             asset_status          @default(ACTIVE)
  purchaseDate       DateTime?
  lastMaintenance    DateTime?
  nextMaintenance    DateTime?
  qrCode             String?
  specifications     String?              // Changed from Json to String for SQLite
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  maintenanceHistory MaintenanceHistory[]
}

model Material {
  id           String     @id
  name         String
  quantity     Int
  unit         String
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id])

  @@index([assignmentId])
}

model RepairLog {
  id           String           @id
  assignmentId String
  technicianId String
  description  String
  action       String
  status       repairlog_status @default(ONGOING)
  timeSpent    Int
  attachments  String?
  createdAt    DateTime         @default(now())
  assignment   Assignment       @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user         SystemUser       @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@index([technicianId])
}

model TechnicianProfile {
  id         String @id
  userId     String @unique
  expertise  String
  area       String
  shift      String
  rating     Float  @default(0)
  totalTasks Int    @default(0)
  user       SystemUser   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Ticket {
  id                 String               @id
  ticketNumber       String               @unique
  category           String
  subject            String
  description        String
  location           String
  priority           ticket_priority      @default(MEDIUM)
  status             ticket_status        @default(PENDING)
  reporterId         String
  attachments        String?
  estimatedTime      Int?                 // in minutes
  actualTime         Int?                 // in minutes
  notes              String?
  contactPerson      String?
  contactPhone       String?
  assetCode          String?
  severity           ticket_severity      @default(NORMAL)
  resolutionNotes    String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  completedAt        DateTime?
  assignment         Assignment?
  user               SystemUser           @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  maintenanceHistory MaintenanceHistory[]

  @@index([reporterId], map: "Ticket_reporterId_fkey")
}

enum ticket_severity {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum user_role {
  ADMIN
  STAFF
  TECHNICIAN
  SUPERVISOR
}

enum asset_status {
  ACTIVE
  MAINTENANCE
  RETIRED
}

enum assignment_status {
  PENDING
  ACCEPTED
  REJECTED
  IN_PROGRESS
  COMPLETED
}

enum repairlog_status {
  ONGOING
  COMPLETED
  NEED_PARTS
}

enum ticket_priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ticket_status {
  PENDING
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
}
